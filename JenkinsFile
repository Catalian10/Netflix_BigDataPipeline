pipeline {
    agent any

    stages {
        stage('Clone Repository') {
            steps {
                git branch: 'main', url: 'https://github.com/Catalian10/Netflix_BigDataPipeline.git'
            }
        }

        stage('Deploy to EC2') {
            steps {
                sshagent(['72c493c4-cb5d-41e2-add5-0509549afaef']) {
                    // Copy project folder to EC2
                    sh 'scp -r ./Netflix_BigDataPipeline ec2-user@your-ec2-ip:/path/to/deployment/'
                }
            }
        }

        stage('Run Python Scripts') {
            steps {
                sshagent(['72c493c4-cb5d-41e2-add5-0509549afaef']) {
                    // SSH into EC2 and run the main Python script
                    sh 'ssh ec2-user@your-ec2-ip "cd /home/ec2-user/BigdataProject_Final_S/Jenkins/Netflix_BigDataPipeline && python3 main_script.py"'
                }
            }
        }

        stage('Verify Output') {
            steps {
                sshagent(['72c493c4-cb5d-41e2-add5-0509549afaef']) {
                    // Check for script logs or output after execution
                    sh 'ssh ec2-user@ip-172-31-14-3 "cat /home/ec2-user/BigdataProject_Final_S/Jenkins/log_file.txt"'
                }
            }
        }
    }

    post {
        success {
            echo 'Python script ran successfully on EC2!'
        }
        failure {
            echo 'Pipeline failed. Check the logs for details.'
        }
    }
}
